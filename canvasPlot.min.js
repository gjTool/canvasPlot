"use strict";!function(e,t){console.log("canvasPlot.js v0.0.1  https://www.gjtool.cn"),"function"==typeof define&&define.amd?define(function(){return t(e,"0.0.1")}):"undefined"!=typeof module&&module.exports?module.exports=t(e,"0.0.1"):e.CanvasPlot=t(e,"0.0.1")}("undefined"!=typeof window?window:void 0,function(e,t){function r(n){function l(){de.clear(),F.save(),F.setTransform(1,0,0,1,0,0),F.clearRect(0,0,L.width,L.height),F.restore(),J=!1,de.draw()}function c(e){var t=e.clientX,r=e.clientY;e.cancelBubble=!0,he.innerHTML='<ul style="margin: 0;padding: 10px 0;list-style: none;font-size:12px;"><li index="0" style="padding: 0px 10px;cursor: pointer;color:red;">'+M+"</li></ul>",he.style.left=t+"px",he.style.top=r+"px",he.style.display="block"}function d(e){if(1!==e.button&&ee){var t=x();if(ne.x=e.offsetX,ne.y=e.offsetY,"rect"===A){var r=Math.abs(se.x-ne.x),i=Math.abs(se.y-ne.y);de.clear(),F.beginPath(),b=se.x,m=se.y,ne.x>=b?ne.y>=m?(w=r,C=i):(w=r,C=-i):ne.y>=m?(w=-r,C=i):(w=-r,C=-i),J=!1,de.draw(),b+=t.x,m+=t.y,b/=t.scale,m/=t.scale,w/=t.scale,C/=t.scale,F.strokeRect(b,m,w,C)}}}function h(e){1!==e.button&&("rect"===A&&((w<0||C<0)&&(b+=w,m+=C,w=-w,C=-C),void 0!==b&&void 0!==m&&void 0!==w&&void 0!==C&&w>=5&&C>=5&&de.addPlot({x:b,y:m,w:w,h:C}),Q=a(Q),L.removeEventListener("mousemove",d),re&&(ee=!1),L.removeEventListener("mouseup",h),b=void 0,m=void 0,w=void 0,C=void 0,se={x:0,y:0},ne={x:0,y:0}),de.fire("drawFinish",A))}function f(e){if(he&&(he.style.display="none"),1!==e.button){var t=de.getMouse(e),r=t.x,i=t.y;if(D.x=r,D.y=i,$&&2===e.button){var t=de.getMouse(e),r=t.x,i=t.y;document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none",W=F.transformedPoint(r,i),j=!1,L.addEventListener("mousemove",u),L.addEventListener("mouseup",y)}else{var o=x();r+=o.x,i+=o.y,F.strokeStyle=P,F.lineWidth=z;var s=Q,n=s.length,a=!1;if("rect"===A){for(var l=n-1;l>=0;l--){var c=s[l];if(c.contains(r,i)&&!1===a){if(c.disabled)return te=null,c.delselected=!1,c.selected=!1,void(J=!1);te=c,te.dragging=!0,ie=r-c.x*o.scale,oe=i-c.y*o.scale,te===c&&(s[l].getCheckSideLengthResult(r,i)?(g(e,c),te.resizing=!0,te.dragging=!1):te.resizing=!1),c.delselected=!1,c.selected=!0,J=!1,a=!0}else c.delselected=!1,c.selected=!1,J=!1}if(!1===a&&(te=null),te&&(L.style.cursor="move",de.toTop(te)),te&&(te.dragging||te.resizing))return;se.x=e.offsetX,se.y=e.offsetY,L.addEventListener("mousemove",d),L.addEventListener("mouseup",h)}}}}function u(e){if($){var t=de.getMouse(e),r=t.x,i=t.y;if(j=!0,W){var o=F.transformedPoint(r,i);F.translate(o.x-W.x,o.y-W.y),l()}}}function y(e){$&&(de.fire("dragMoveFinish",W),W=null,j||fe(e.shiftKey?-1:1),L.removeEventListener("mousemove",u),L.removeEventListener("mouseup",y))}function g(e,t){if(!t.disabled){var r=x(),i=de.getMouse(e),o=i.x+r.x,s=i.y+r.y;if("rect"===A){switch(t.getCheckSideLengthResult(o,s)){case"topL":B=!0,e.target.style.cursor="nw-resize";break;case"topM":H=!0,e.target.style.cursor="n-resize";break;case"topR":U=!0,e.target.style.cursor="ne-resize";break;case"rightM":case"rightM":X=!0,e.target.style.cursor="e-resize";break;case"bottomL":Y=!0,e.target.style.cursor="sw-resize";break;case"bottomM":G=!0,e.target.style.cursor="s-resize";break;case"bottomR":V=!0,e.target.style.cursor="se-resize";break;case"leftM":K=!0,e.target.style.cursor="w-resize"}J=!1}}}function p(e){"rect"===A&&(B=H=U=X=Y=G=V=K=!1)}function v(e,t){var r=x(),i=de.getMouse(e),o=(i.x+r.x)/r.scale,s=(i.y+r.y)/r.scale,n=t.x,a=t.y,l=t.w,c=t.h;"rect"===A&&(B?(e.target.style.cursor="nw-resize",n+l-o<0&&(B=!1,U=!0),a+c-s<0&&(B=!1,Y=!0),t.w+=n-o,t.h+=a-s,t.x=o,t.y=s):H?(e.target.style.cursor="n-resize",n-o>0&&(H=!1,G=!0),a+c-s<0&&(H=!1,G=!0),t.h+=a-s,t.y=s):U?(e.target.style.cursor="ne-resize",n-o>0&&(U=!1,B=!0),a+c-s<0&&(U=!1,V=!0),t.w=Math.abs(n-o),t.h+=a-s,t.y=s):X?(e.target.style.cursor="e-resize",n-o>0&&(X=!1,K=!0),a+c-s<0&&(X=!1,K=!0),t.w+=o-n-l):Y?(e.target.style.cursor="sw-resize",n+l-o<0&&(Y=!1,V=!0),a-s>0&&(Y=!1,B=!0),t.w+=n-o,t.h=Math.abs(a-s),t.x=o):G?(e.target.style.cursor="s-resize",n-o>0&&(G=!1,H=!0),a-s>0&&(G=!1,H=!0),t.h+=s-a-c):V?(e.target.style.cursor="se-resize",n-o>0&&(V=!1,Y=!0),a-s>0&&(V=!1,U=!0),t.w=Math.abs(n-o),t.h=Math.abs(a-s)):K&&(e.target.style.cursor="w-resize",n+l-o<0&&(K=!1,X=!0),a+c-s<0&&(K=!1,X=!0),t.w+=n-o,t.x=o),J=!1)}function x(){var e=F.getTransform();return{scale:e.d,x:-e.e,y:-e.f}}if("[object Object]"!==Object.prototype.toString.call(n))throw Error("new CanvasPlot(options). Parameter 'options' must be an object.");var b,m,w,C,L=document.createElement("canvas");this.version=t;var k=n.parentNode instanceof HTMLElement?n.parentNode:document.body,M=n.deleteBtnText||"删除",S=n.selectionBorderColor||"#00ff00",z=n.selectionBorderWidth||1,R=n.selectionRectColor||"#00ff00",E=n.selectionFillColor||"#ffffff",P=n.borderColor||"#0d0efd",T=n.imagePath||"",I=n.showMenu||!1;L.width=n.width||300,L.height=n.height||300,L.style=n.border?"border: "+n.border:"border: 1px solid black";var W,j,D={x:L.width/2,y:L.height/2};k.appendChild(L);var F=L.getContext("2d"),N=0,O=0;F.fillStyle="#ffffff",F.fillRect(0,0,L.width,L.height),e&&e.getComputedStyle&&(N=parseFloat(e.getComputedStyle(L).borderLeftWidth)||0,O=parseFloat(e.getComputedStyle(L).borderTopWidth)||0);var A,B,H,U,X,Y,G,V,K,Z=document.body.parentNode,_=Z.offsetTop,q=Z.offsetLeft,J=!1,Q=[],$=!0,ee=!1,te=null,re=!1,ie=0,oe=0,se={x:0,y:0},ne={x:0,y:0},ae=null,le=null,ce={},de=this;if(I){var he=document.createElement("div");he.className="right_menu",he.style.position="absolute",he.style.background="#ffffff",he.style.border="solid 1px  #ebeef5",he.style.display="none",he.style.borderRadius="4px",he.style.boxShadow="0 2px 12px 0 rgb(0 0 0 / 10%)",k.appendChild(he),he.addEventListener("click",function(e){var t=e.target;if("li"===t.nodeName.toLowerCase()){var r=t.getAttribute("index");0==r&&(de.delPlot(te),J=!1,te=null,he.style.display="none"),1==r&&(he.style.display="none")}},!0)}L.addEventListener("selectstart",function(e){return e.preventDefault(),!1},!1),L.oncontextmenu=function(e){return e.preventDefault(),!1},L.addEventListener("mousedown",f,!0),L.addEventListener("mousemove",function(e){if(1!==e.button){var t=de.getMouse(e),r=t.x,i=t.y;if(D.x=r,D.y=i,!(te&&te.disabled||"rect"!==A)){var o=x();r+=o.x,i+=o.y,te&&te.dragging?(te.x=(r-ie)/o.scale,te.y=(i-oe)/o.scale,J=!1):this.style.cursor="auto",te&&te.resizing&&v(e,te);for(var s=Q,n=s.length,a=n-1;a>=0;a--){var l=s[a];if(l.contains(r,i)){if(l.disabled)return;if(te===l){switch(l.getCheckSideLengthResult(r,i)){case"topL":e.target.style.cursor="nw-resize";break;case"topM":e.target.style.cursor="n-resize";break;case"topR":e.target.style.cursor="ne-resize";break;case"rightM":case"rightM":e.target.style.cursor="e-resize";break;case"bottomL":e.target.style.cursor="sw-resize";break;case"bottomM":e.target.style.cursor="s-resize";break;case"bottomR":e.target.style.cursor="se-resize";break;case"leftM":e.target.style.cursor="w-resize";break;default:this.style.cursor="move"}}break}}}}},!0),L.addEventListener("mouseup",function(e){if(1!==e.button){var t=de.getMouse(e),r=t.x,i=t.y;if(D.x=r,D.y=i,$&&2===e.button);else{if(te&&te.disabled)return;te&&(te.dragging=!1,te.resizing=!1),p(e)}this.style.cursor="auto"}},!0),L.addEventListener("dblclick",function(e){if(1!==e.button&&(!te||!te.disabled)&&I&&(!te||!te.dragging&&!te.resizing)){var t=de.getMouse(e),r=t.x,i=t.y;he.style.display="none";for(var o=Q,s=o.length,n=!1,a=s-1;a>=0;a--){var l=o[a];if(l.contains(r,i)&&!1===n){if(l.disabled)return l.selected=!1,l.delselected=!1,J=!1,te=null,!1;te=l,l.selected=!1,l.delselected=!0,J=!1,n=!0,c(e)}else l.selected=!1,l.delselected=!1,J=!1}!1===n&&(te=null)}},!0);var fe=function(e){if($){if(1==e)return;var t=F.transformedPoint(D.x,D.y);F.translate(t.x,t.y);var r=Math.pow(1.1,e);F.scale(r,r),F.translate(-t.x,-t.y),l()}},ue=function(e){if($){var t=e.wheelDelta?e.wheelDelta/200:e.detail?-e.detail:0;return t&&fe(t),e.preventDefault()&&!1}};L.addEventListener("DOMMouseScroll",ue,!1),L.addEventListener("mousewheel",ue,!1),r.prototype.getOffset=x,r.prototype.render=function(){var e=this;T&&this.addImage(T),clearInterval(le),le=setInterval(function(){e.draw()},100)},r.prototype.getPlotCaches=function(){return Q},r.prototype.getSelection=function(){return te},r.prototype.addImage=function(e,t,r){var i=L.width,o=L.height;if(ae&&ae.loaded)void 0!==t&&void 0!==r?F.drawImage(ae,t,r):F.drawImage(ae,(i-ae.width)/2,(o-ae.height)/2);else{var s=new Image;s.src=e,s.onload=function(){ae=s,s.loaded=!0;var e=s.width,n=s.height;void 0!==t&&void 0!==r?F.drawImage(s,t,r):F.drawImage(s,(i-e)/2,(o-n)/2)}}},r.prototype.setImage=function(e,t,r){var i=L.width,o=L.height,s=new Image;s.src=e,s.onload=function(){ae=s,T=e,s.loaded=!0;var n=s.width,a=s.height;void 0!==t&&void 0!==r?F.drawImage(s,t,r):F.drawImage(s,(i-n)/2,(o-a)/2),J=!1}},r.prototype.toTop=function(e){for(var t=Q,r=t.length,i=r-1;i>=0;i--){if(e===t[i]){t.splice(i,1);break}}e.index=r-1,Q.push(e)},r.prototype.addPlot=function(e){switch(A){case"rect":this.addRect(e);break;case"text":this.addText(e)}},r.prototype.delPlot=function(e){for(var t=Q,r=t.length,i=r-1;i>=0;i--){if(e===t[i]){t.splice(i,1);break}}},r.prototype.addRect=function(e){Q.push(new ye(e)),J=!1},r.prototype.addText=function(e){Q.push(new ge(e)),J=!1},r.prototype.clear=function(){var e=F.transformedPoint(0,0),t=F.transformedPoint(L.width,L.height);F.clearRect(e.x,e.y,t.x-e.x,t.y-e.y)},r.prototype.draw=function(){if(!J){var e=x(),t=Q;this.clear(),F.fillStyle="#ffffff",F.fillRect(e.x/e.scale,e.y/e.scale,L.width,L.height),T&&this.addImage(T);for(var r=t.length,i=0;i<r;i++){var o=t[i];if(o.index=i,te!==o){if(void 0===o.x||void 0===o.y||void 0===o.w||void 0===o.h)continue;t[i].draw(F)}}null!==te&&te.draw(F),J=!0}},r.prototype.getMouse=function(e){var t,r,i=L,o=0,s=0;if(void 0!==i.offsetParent)do{o+=i.offsetLeft,s+=i.offsetTop}while(i=i.offsetParent);return o+=N+q,s+=O+_,t=e.pageX-o,r=e.pageY-s,{x:t,y:r}},r.prototype.screenshot=function(e){return e=e||"png",L.toDataURL("image/"+e)},r.prototype.downLoad=function(e){var t=document.createElement("a");t.download="",t.href=this.screenshot(e),document.body.appendChild(t),t.click(),document.body.removeChild(t)},r.prototype.on=function(e,t,r){if("[object Function]"!==Object.prototype.toString.call(t))throw Error("CanvasPlot.on('"+e+"',fn). Parameter 'fn' must be a function.");!0===r?ce[e]=[t]:ce[e]&&ce[e]instanceof Array?ce[e].push(t):ce[e]=[t]},r.prototype.off=function(e,t){if(!0===e)return ce={};if("[object Function]"!==Object.prototype.toString.call(t))return ce[e]=[];if(ce[e]&&ce[e]instanceof Array){var r=ce[e],i=r.indexOf(t);if(i>-1)return r.splice(i,1)}},r.prototype.fire=function(e,t,r){var i=ce[e];if(i&&i instanceof Array)for(var o=0;o<i.length;o++)i[o]&&i[o].call(this,t,r)},r.prototype.drawRectBegin=function(e){ee=!0,A="rect",re=e||!1},r.prototype.drawRectFinish=function(){ee=!1,A=void 0},r.prototype.setCanvasDragZoom=function(e){$=e},function(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg"),r=t.createSVGMatrix();e.getTransform=function(){return r};var i=[],o=e.save;e.save=function(){if($)return i.push(r.translate(0,0)),o.call(e)};var s=e.restore;e.restore=function(){if($)return r=i.pop(),s.call(e)};var n=e.scale;e.scale=function(t,i){if($)return r=r.scaleNonUniform(t,i),n.call(e,t,i)};var a=e.rotate;e.rotate=function(t){if($)return r=r.rotate(180*t/Math.PI),a.call(e,t)};var l=e.translate;e.translate=function(t,i){if($)return r=r.translate(t,i),l.call(e,t,i)};var c=e.transform;e.transform=function(i,o,s,n,a,l){if($){var d=t.createSVGMatrix();return d.a=i,d.b=o,d.c=s,d.d=n,d.e=a,d.f=l,r=r.multiply(d),c.call(e,i,o,s,n,a,l)}};var d=e.setTransform;e.setTransform=function(t,i,o,s,n,a){if($)return r.a=t,r.b=i,r.c=o,r.d=s,r.e=n,r.f=a,d.call(e,t,i,o,s,n,a)};var h=t.createSVGPoint();e.transformedPoint=function(e,t){if($)return h.x=e,h.y=t,h.matrixTransform(r.inverse())}}(F),this.render();var ye=function(e){this.x=e.x||0,this.y=e.y||0,this.w=e.w||1,this.h=e.h||1,this.fill=void 0===e.color?"rgba(255, 255, 255, 0)":e.color,this.strokeColor=void 0===e.borderColor?P:e.borderColor,this.lineWidth=void 0!==e.borderWidth?e.borderWidth:1,this.selected=e.selected||!1,this.delselected=e.delselected||!1,this.sideLength=10,this.rectColor=e.rectColor||R,this.fillColor=e.fillColor||E,this.disabled=e.disabled||!1,this.dragging=!1,this.resizing=!1,this.index=e.index||0,this.type="rect",this.uuid=i()};ye.prototype.draw=function(e){e.fillStyle=this.fill,e.fillRect(this.x,this.y,this.w,this.h),this.lineWidth&&!this.selected?(this.delselected?(e.strokeStyle="#ff0000",e.lineWidth=3):(e.strokeStyle=this.strokeColor,e.lineWidth=this.lineWidth),e.strokeRect(this.x,this.y,this.w,this.h)):this.selected&&(e.strokeStyle=S,e.lineWidth=z,e.strokeRect(this.x,this.y,this.w,this.h),this.drawHandles(e))},ye.prototype.drawHandles=function(e){o(this.x,this.y,this.sideLength,e,this.rectColor,this.fillColor),o(this.x+this.w,this.y,this.sideLength,e,this.rectColor,this.fillColor),o(this.x,this.y+this.h,this.sideLength,e,this.rectColor,this.fillColor),o(this.x+this.w,this.y+this.h,this.sideLength,e,this.rectColor,this.fillColor),o(this.x+this.w/2,this.y,this.sideLength,e,this.rectColor,this.fillColor),o(this.x+this.w,this.y+this.h/2,this.sideLength,e,this.rectColor,this.fillColor),o(this.x,this.y+this.h/2,this.sideLength,e,this.rectColor,this.fillColor),o(this.x+this.w/2,this.y+this.h,this.sideLength,e,this.rectColor,this.fillColor)},ye.prototype.contains=function(e,t){return!!this.getCheckSideLengthResult(e,t)||(!0===this.getContainsRectResult(e,t)||void 0)},ye.prototype.getContainsRectResult=function(e,t){var r=x(),i=this.w*r.scale,o=this.h*r.scale,s=this.x*r.scale,n=this.y*r.scale,a=!1,l=!1;return a=i>=0?s<=e&&s+i>=e:s>=e&&s+i<=e,l=o>=0?n<=t&&n+o>=t:n>=t&&n+o<=t,a&&l},ye.prototype.getCheckSideLengthResult=function(e,t){var r=x(),i=this.w*r.scale,o=this.h*r.scale,n=this.sideLength*r.scale,a=this.x*r.scale,l=this.y*r.scale;return s(e,t,a,l,n)?"topL":s(e,t,a+i/2,l,n)?"topM":s(e,t,a+i,l,n)?"topR":s(e,t,a+i,l+o/2,n)?"rightM":s(e,t,a,l+o,n)?"bottomL":s(e,t,a+i/2,l+o,n)?"bottomM":s(e,t,a+i,l+o,n)?"bottomR":s(e,t,a,l+o/2,n)?"leftM":void 0};var ge=function(e){this.x=e.x||0,this.y=e.y||0,this.fontSize=e.fontSize||"16px",this.text=e.text||"这是文本",this.color=void 0===e.color?"rgba(255, 255, 255, 0)":e.color,this.selected=e.selected||!1,this.delselected=e.delselected||!1,this.disabled=e.disabled||!1,this.index=e.index||0,this.type="text",this.uuid=i()};ge.prototype.draw=function(e){e.font=this.fontSize+" Arial",e.fillStyle=this.color,this.selected&&(e.fillStyle=S),this.delselected&&(e.fillStyle="#ff0000"),e.fillText(this.text,this.x,this.y)},ge.prototype.contains=function(e,t){},ge.prototype.getContainsRectResult=function(e,t){},ge.prototype.getCheckSideLengthResult=function(e,t){}}function i(){return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}function o(e,t,r,i,o,s){i.save(),i.fillStyle=o,i.fillRect(e-r/2,t-r/2,r,r),i.fillStyle=s,i.fillRect(e-(r-3)/2,t-(r-3)/2,r-3,r-3),i.restore()}function s(e,t,r,i,o){if(n(e,r,o)&&n(t,i,o))return!0}function n(e,t,r){return Math.abs(e-t)<r}function a(e){var t={};return e.reduce(function(e,r){return t[r.uuid]||(t[r.uuid]=e.push(r)),e},[])}return r});