"use strict";!function(e,t){console.log("canvasPlot.js v0.0.4  https://www.gjtool.cn"),"function"==typeof define&&define.amd?define(function(){return t(e,"0.0.4")}):"undefined"!=typeof module&&module.exports?module.exports=t(e,"0.0.4"):e.CanvasPlot=t(e,"0.0.4")}("undefined"!=typeof window?window:void 0,function(e,t){function r(n){function l(){fe.clear(),O.save(),O.setTransform(1,0,0,1,0,0),O.clearRect(0,0,k.width,k.height),O.restore(),Q=!1,fe.draw()}function c(e){var t=e.clientX,r=e.clientY;e.cancelBubble=!0,he.innerHTML='<ul style="margin: 0;padding: 10px 0;list-style: none;font-size:12px;"><li index="0" style="padding: 0px 10px;cursor: pointer;color:red;">'+S+"</li></ul>",he.style.left=t+"px",he.style.top=r+"px",he.style.display="block"}function d(e){if(1!==e.button&&te){var t=x();if(ae.x=e.offsetX,ae.y=e.offsetY,"rect"===B){var r=Math.abs(ne.x-ae.x),o=Math.abs(ne.y-ae.y);fe.clear(),O.beginPath(),m=ne.x,w=ne.y,ae.x>=m?ae.y>=w?(C=r,L=o):(C=r,L=-o):ae.y>=w?(C=-r,L=o):(C=-r,L=-o),Q=!1,fe.draw(),m+=t.x,w+=t.y,m/=t.scale,w/=t.scale,C/=t.scale,L/=t.scale,O.strokeRect(m,w,C,L)}}}function f(e){1!==e.button&&("rect"===B&&((C<0||L<0)&&(m+=C,w+=L,C=-C,L=-L),void 0!==m&&void 0!==w&&void 0!==C&&void 0!==L&&C>=5&&L>=5&&fe.addPlot({x:m,y:w,w:C,h:L}),$=a($),k.removeEventListener("mousemove",d),oe&&(te=!1),k.removeEventListener("mouseup",f),m=void 0,w=void 0,C=void 0,L=void 0,ne={x:0,y:0},ae={x:0,y:0}),fe.fire("drawFinish",B))}function h(e){if(he&&(he.style.display="none"),1!==e.button){var t=fe.getMouse(e),r=t.x,o=t.y;if(F.x=r,F.y=o,ee&&2===e.button){var t=fe.getMouse(e),r=t.x,o=t.y;document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none",j=O.transformedPoint(r,o),D=!1,k.addEventListener("mousemove",u),k.addEventListener("mouseup",y)}else{var i=x();r+=i.x,o+=i.y,O.strokeStyle=T,O.lineWidth=z;var s=$,n=s.length,a=!1;if("rect"===B){for(var l=n-1;l>=0;l--){var c=s[l];if(c.contains(r,o)&&!1===a){if(c.disabled)return re=null,c.delselected=!1,c.selected=!1,void(Q=!1);re=c,re.dragging=!0,ie=r-c.x*i.scale,se=o-c.y*i.scale,re===c&&(s[l].getCheckSideLengthResult(r,o)?(g(e,c),re.resizing=!0,re.dragging=!1):re.resizing=!1),c.delselected=!1,c.selected=!0,Q=!1,a=!0}else c.delselected=!1,c.selected=!1,Q=!1}if(!1===a&&(re=null),re&&(k.style.cursor="move",fe.toTop(re)),re&&(re.dragging||re.resizing))return;ne.x=e.offsetX,ne.y=e.offsetY,k.addEventListener("mousemove",d),k.addEventListener("mouseup",f)}}}}function u(e){if(ee){var t=fe.getMouse(e),r=t.x,o=t.y;if(D=!0,j){var i=O.transformedPoint(r,o);O.translate(i.x-j.x,i.y-j.y),l()}}}function y(e){ee&&(fe.fire("dragMoveFinish",j),j=null,D||ue(e.shiftKey?-1:1),k.removeEventListener("mousemove",u),k.removeEventListener("mouseup",y))}function g(e,t){if(!t.disabled){var r=x(),o=fe.getMouse(e),i=o.x+r.x,s=o.y+r.y;if("rect"===B){switch(t.getCheckSideLengthResult(i,s)){case"topL":H=!0,e.target.style.cursor="nw-resize";break;case"topM":U=!0,e.target.style.cursor="n-resize";break;case"topR":X=!0,e.target.style.cursor="ne-resize";break;case"rightM":case"rightM":Y=!0,e.target.style.cursor="e-resize";break;case"bottomL":G=!0,e.target.style.cursor="sw-resize";break;case"bottomM":V=!0,e.target.style.cursor="s-resize";break;case"bottomR":K=!0,e.target.style.cursor="se-resize";break;case"leftM":Z=!0,e.target.style.cursor="w-resize"}Q=!1}}}function p(e){"rect"===B&&(H=U=X=Y=G=V=K=Z=!1)}function v(e,t){var r=x(),o=fe.getMouse(e),i=(o.x+r.x)/r.scale,s=(o.y+r.y)/r.scale,n=t.x,a=t.y,l=t.w,c=t.h;"rect"===B&&(H?(e.target.style.cursor="nw-resize",n+l-i<0&&(H=!1,X=!0),a+c-s<0&&(H=!1,G=!0),t.w+=n-i,t.h+=a-s,t.x=i,t.y=s):U?(e.target.style.cursor="n-resize",n-i>0&&(U=!1,V=!0),a+c-s<0&&(U=!1,V=!0),t.h+=a-s,t.y=s):X?(e.target.style.cursor="ne-resize",n-i>0&&(X=!1,H=!0),a+c-s<0&&(X=!1,K=!0),t.w=Math.abs(n-i),t.h+=a-s,t.y=s):Y?(e.target.style.cursor="e-resize",n-i>0&&(Y=!1,Z=!0),a+c-s<0&&(Y=!1,Z=!0),t.w+=i-n-l):G?(e.target.style.cursor="sw-resize",n+l-i<0&&(G=!1,K=!0),a-s>0&&(G=!1,H=!0),t.w+=n-i,t.h=Math.abs(a-s),t.x=i):V?(e.target.style.cursor="s-resize",n-i>0&&(V=!1,U=!0),a-s>0&&(V=!1,U=!0),t.h+=s-a-c):K?(e.target.style.cursor="se-resize",n-i>0&&(K=!1,G=!0),a-s>0&&(K=!1,X=!0),t.w=Math.abs(n-i),t.h=Math.abs(a-s)):Z&&(e.target.style.cursor="w-resize",n+l-i<0&&(Z=!1,Y=!0),a+c-s<0&&(Z=!1,Y=!0),t.w+=n-i,t.x=i),Q=!1)}function x(){var e=O.getTransform();return{scale:e.d,x:-e.e,y:-e.f}}function b(e){O.setTransform(e.scale,0,0,e.scale,-e.x,-e.y),l()}if("[object Object]"!==Object.prototype.toString.call(n))throw Error("new CanvasPlot(options). Parameter 'options' must be an object.");var m,w,C,L,k=document.createElement("canvas");this.version=t;var M=n.parentNode instanceof HTMLElement?n.parentNode:document.body,S=n.deleteBtnText||"删除",R=n.selectionBorderColor||"#00ff00",z=n.selectionBorderWidth||1,E=n.selectionRectColor||"#00ff00",P=n.selectionFillColor||"#ffffff",T=n.borderColor||"#0d0efd",I=n.imagePath||"",W=n.showMenu||!1;k.width=n.width||300,k.height=n.height||300,k.style=n.border?"border: "+n.border:"border: 1px solid black";var j,D,F={x:k.width/2,y:k.height/2};M.appendChild(k);var O=k.getContext("2d"),N=0,A=0;O.fillStyle="#ffffff",O.fillRect(0,0,k.width,k.height),e&&e.getComputedStyle&&(N=parseFloat(e.getComputedStyle(k).borderLeftWidth)||0,A=parseFloat(e.getComputedStyle(k).borderTopWidth)||0);var B,H,U,X,Y,G,V,K,Z,_=document.body.parentNode,q=_.offsetTop,J=_.offsetLeft,Q=!1,$=[],ee=!0,te=!1,re=null,oe=!1,ie=0,se=0,ne={x:0,y:0},ae={x:0,y:0},le=null,ce=null,de={},fe=this;if(W){var he=document.createElement("div");he.className="right_menu",he.style.position="absolute",he.style.background="#ffffff",he.style.border="solid 1px  #ebeef5",he.style.display="none",he.style.borderRadius="4px",he.style.boxShadow="0 2px 12px 0 rgb(0 0 0 / 10%)",M.appendChild(he),he.addEventListener("click",function(e){var t=e.target;if("li"===t.nodeName.toLowerCase()){var r=t.getAttribute("index");0==r&&(fe.delPlot(re),Q=!1,re=null,he.style.display="none"),1==r&&(he.style.display="none")}},!0)}k.addEventListener("selectstart",function(e){return e.preventDefault(),!1},!1),k.oncontextmenu=function(e){return e.preventDefault(),!1},k.addEventListener("mousedown",h,!0),k.addEventListener("mousemove",function(e){if(1!==e.button){var t=fe.getMouse(e),r=t.x,o=t.y;if(F.x=r,F.y=o,!(re&&re.disabled||"rect"!==B)){var i=x();r+=i.x,o+=i.y,re&&re.dragging?(re.x=(r-ie)/i.scale,re.y=(o-se)/i.scale,Q=!1):this.style.cursor="auto",re&&re.resizing&&v(e,re);for(var s=$,n=s.length,a=n-1;a>=0;a--){var l=s[a];if(l.contains(r,o)){if(l.disabled)return;if(re===l){switch(l.getCheckSideLengthResult(r,o)){case"topL":e.target.style.cursor="nw-resize";break;case"topM":e.target.style.cursor="n-resize";break;case"topR":e.target.style.cursor="ne-resize";break;case"rightM":case"rightM":e.target.style.cursor="e-resize";break;case"bottomL":e.target.style.cursor="sw-resize";break;case"bottomM":e.target.style.cursor="s-resize";break;case"bottomR":e.target.style.cursor="se-resize";break;case"leftM":e.target.style.cursor="w-resize";break;default:this.style.cursor="move"}}break}}}}},!0),k.addEventListener("mouseup",function(e){if(1!==e.button){var t=fe.getMouse(e),r=t.x,o=t.y;if(F.x=r,F.y=o,ee&&2===e.button);else{if(re&&re.disabled)return;re&&(re.dragging=!1,re.resizing=!1),p(e)}this.style.cursor="auto"}},!0),k.addEventListener("dblclick",function(e){if(1!==e.button&&(!re||!re.disabled)&&W&&(!re||!re.dragging&&!re.resizing)){var t=fe.getMouse(e),r=t.x,o=t.y,i=x();r+=i.x,o+=i.y,he.style.display="none";for(var s=$,n=s.length,a=!1,l=n-1;l>=0;l--){var d=s[l];if(d.contains(r,o)&&!1===a){if(d.disabled)return d.selected=!1,d.delselected=!1,Q=!1,re=null,!1;re=d,d.selected=!1,d.delselected=!0,Q=!1,a=!0,c(e)}else d.selected=!1,d.delselected=!1,Q=!1}!1===a&&(re=null)}},!0);var ue=function(e){if(ee){if(1==e)return;var t=O.transformedPoint(F.x,F.y);O.translate(t.x,t.y);var r=Math.pow(1.1,e);O.scale(r,r),O.translate(-t.x,-t.y),l()}},ye=function(e){if(ee){var t=e.wheelDelta?e.wheelDelta/200:e.detail?-e.detail:0;return t&&ue(t),e.preventDefault()&&!1}};k.addEventListener("DOMMouseScroll",ye,!1),k.addEventListener("mousewheel",ye,!1),r.prototype.getOffset=x,r.prototype.setOffset=b,r.prototype.render=function(){var e=this;I&&this.addImage(I),clearInterval(ce),ce=setInterval(function(){e.draw()},100)},r.prototype.getData=function(){return{offset:x(),data:$}},r.prototype.setData=function(e){if(e.offset&&b(e.offset),e.data)for(var t=0;t<e.data.length;t++)this.addRect(e.data[t])},r.prototype.getPlotCaches=function(){return $},r.prototype.getSelection=function(){return re},r.prototype.addImage=function(e,t,r){var o=k.width,i=k.height;if(le&&le.loaded)void 0!==t&&void 0!==r?O.drawImage(le,t,r):O.drawImage(le,(o-le.width)/2,(i-le.height)/2);else{var s=new Image;s.src=e,s.onload=function(){le=s,s.loaded=!0;var e=s.width,n=s.height;void 0!==t&&void 0!==r?O.drawImage(s,t,r):O.drawImage(s,(o-e)/2,(i-n)/2)}}},r.prototype.setImage=function(e,t,r){var o=k.width,i=k.height,s=new Image;s.src=e,s.onload=function(){le=s,I=e,s.loaded=!0;var n=s.width,a=s.height;void 0!==t&&void 0!==r?O.drawImage(s,t,r):O.drawImage(s,(o-n)/2,(i-a)/2),Q=!1}},r.prototype.toTop=function(e){for(var t=$,r=t.length,o=r-1;o>=0;o--){if(e===t[o]){t.splice(o,1);break}}e.index=r-1,$.push(e)},r.prototype.addPlot=function(e){switch(e.type||B){case"rect":this.addRect(e);break;case"text":this.addText(e);break;default:this.addRect(e)}},r.prototype.delPlot=function(e){for(var t=$,r=t.length,o=r-1;o>=0;o--){if(e===t[o]){t.splice(o,1);break}}},r.prototype.addRect=function(e){$.push(new ge(e)),Q=!1},r.prototype.addText=function(e){$.push(new pe(e)),Q=!1},r.prototype.clear=function(){var e=O.transformedPoint(0,0),t=O.transformedPoint(k.width,k.height);O.clearRect(e.x,e.y,t.x-e.x,t.y-e.y)},r.prototype.draw=function(){if(!Q){var e=x(),t=$;this.clear(),O.fillStyle="#ffffff",O.fillRect(e.x/e.scale,e.y/e.scale,k.width,k.height),I&&this.addImage(I);for(var r=t.length,o=0;o<r;o++){var i=t[o];if(i.index=o,re!==i){if(void 0===i.x||void 0===i.y||void 0===i.w||void 0===i.h)continue;t[o].draw(O)}}null!==re&&re.draw(O),Q=!0}},r.prototype.getMouse=function(e){var t,r,o=k,i=0,s=0;if(void 0!==o.offsetParent)do{i+=o.offsetLeft,s+=o.offsetTop}while(o=o.offsetParent);return i+=N+J,s+=A+q,t=e.pageX-i,r=e.pageY-s,{x:t,y:r}},r.prototype.screenshot=function(e){return e=e||"png",k.toDataURL("image/"+e)},r.prototype.downLoad=function(e){var t=document.createElement("a");t.download="",t.href=this.screenshot(e),document.body.appendChild(t),t.click(),document.body.removeChild(t)},r.prototype.on=function(e,t,r){if("[object Function]"!==Object.prototype.toString.call(t))throw Error("CanvasPlot.on('"+e+"',fn). Parameter 'fn' must be a function.");!0===r?de[e]=[t]:de[e]&&de[e]instanceof Array?de[e].push(t):de[e]=[t]},r.prototype.off=function(e,t){if(!0===e)return de={};if("[object Function]"!==Object.prototype.toString.call(t))return de[e]=[];if(de[e]&&de[e]instanceof Array){var r=de[e],o=r.indexOf(t);if(o>-1)return r.splice(o,1)}},r.prototype.fire=function(e,t,r){var o=de[e];if(o&&o instanceof Array)for(var i=0;i<o.length;i++)o[i]&&o[i].call(this,t,r)},r.prototype.drawRectBegin=function(e){te=!0,B="rect",oe=e||!1},r.prototype.drawRectFinish=function(){te=!1,B=void 0},r.prototype.setCanvasDragZoom=function(e){ee=e};var ge=function(e){this.x=e.x||0,this.y=e.y||0,this.w=e.w||1,this.h=e.h||1,this.fill=void 0===e.color?"rgba(255, 255, 255, 0)":e.color,this.strokeColor=void 0===e.borderColor?T:e.borderColor,this.lineWidth=void 0!==e.borderWidth?e.borderWidth:1,this.selected=e.selected||!1,this.delselected=e.delselected||!1,this.sideLength=10,this.rectColor=e.rectColor||E,this.fillColor=e.fillColor||P,this.disabled=e.disabled||!1,this.dragging=!1,this.resizing=!1,this.index=e.index||0,this.type="rect",this.uuid=o()};ge.prototype.draw=function(e){e.fillStyle=this.fill,e.fillRect(this.x,this.y,this.w,this.h),this.lineWidth&&!this.selected?(this.delselected?(e.strokeStyle="#ff0000",e.lineWidth=3):(e.strokeStyle=this.strokeColor,e.lineWidth=this.lineWidth),e.strokeRect(this.x,this.y,this.w,this.h)):this.selected&&(e.strokeStyle=R,e.lineWidth=z,e.strokeRect(this.x,this.y,this.w,this.h),this.drawHandles(e))},ge.prototype.drawHandles=function(e){i(this.x,this.y,this.sideLength,e,this.rectColor,this.fillColor),i(this.x+this.w,this.y,this.sideLength,e,this.rectColor,this.fillColor),i(this.x,this.y+this.h,this.sideLength,e,this.rectColor,this.fillColor),i(this.x+this.w,this.y+this.h,this.sideLength,e,this.rectColor,this.fillColor),i(this.x+this.w/2,this.y,this.sideLength,e,this.rectColor,this.fillColor),i(this.x+this.w,this.y+this.h/2,this.sideLength,e,this.rectColor,this.fillColor),i(this.x,this.y+this.h/2,this.sideLength,e,this.rectColor,this.fillColor),i(this.x+this.w/2,this.y+this.h,this.sideLength,e,this.rectColor,this.fillColor)},ge.prototype.contains=function(e,t){return!!this.getCheckSideLengthResult(e,t)||(!0===this.getContainsRectResult(e,t)||void 0)},ge.prototype.getContainsRectResult=function(e,t){var r=x(),o=this.w*r.scale,i=this.h*r.scale,s=this.x*r.scale,n=this.y*r.scale,a=!1,l=!1;return a=o>=0?s<=e&&s+o>=e:s>=e&&s+o<=e,l=i>=0?n<=t&&n+i>=t:n>=t&&n+i<=t,a&&l},ge.prototype.getCheckSideLengthResult=function(e,t){var r=x(),o=this.w*r.scale,i=this.h*r.scale,n=this.sideLength*r.scale,a=this.x*r.scale,l=this.y*r.scale;return s(e,t,a,l,n)?"topL":s(e,t,a+o/2,l,n)?"topM":s(e,t,a+o,l,n)?"topR":s(e,t,a+o,l+i/2,n)?"rightM":s(e,t,a,l+i,n)?"bottomL":s(e,t,a+o/2,l+i,n)?"bottomM":s(e,t,a+o,l+i,n)?"bottomR":s(e,t,a,l+i/2,n)?"leftM":void 0};var pe=function(e){this.x=e.x||0,this.y=e.y||0,this.fontSize=e.fontSize||"16px",this.text=e.text||"这是文本",this.color=void 0===e.color?"rgba(255, 255, 255, 0)":e.color,this.selected=e.selected||!1,this.delselected=e.delselected||!1,this.disabled=e.disabled||!1,this.index=e.index||0,this.type="text",this.uuid=o()};pe.prototype.draw=function(e){e.font=this.fontSize+" Arial",e.fillStyle=this.color,this.selected&&(e.fillStyle=R),this.delselected&&(e.fillStyle="#ff0000"),e.fillText(this.text,this.x,this.y)},pe.prototype.contains=function(e,t){},pe.prototype.getContainsRectResult=function(e,t){},pe.prototype.getCheckSideLengthResult=function(e,t){},function(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg"),r=t.createSVGMatrix();e.getTransform=function(){return r};var o=[],i=e.save;e.save=function(){if(ee)return o.push(r.translate(0,0)),i.call(e)};var s=e.restore;e.restore=function(){if(ee)return r=o.pop(),s.call(e)};var n=e.scale;e.scale=function(t,o){if(ee)return r=r.scaleNonUniform(t,o),n.call(e,t,o)};var a=e.rotate;e.rotate=function(t){if(ee)return r=r.rotate(180*t/Math.PI),a.call(e,t)};var l=e.translate;e.translate=function(t,o){if(ee)return r=r.translate(t,o),l.call(e,t,o)};var c=e.transform;e.transform=function(o,i,s,n,a,l){if(ee){var d=t.createSVGMatrix();return d.a=o,d.b=i,d.c=s,d.d=n,d.e=a,d.f=l,r=r.multiply(d),c.call(e,o,i,s,n,a,l)}};var d=e.setTransform;e.setTransform=function(t,o,i,s,n,a){if(ee)return r.a=t,r.b=o,r.c=i,r.d=s,r.e=n,r.f=a,d.call(e,t,o,i,s,n,a)};var f=t.createSVGPoint();e.transformedPoint=function(e,t){if(ee)return f.x=e,f.y=t,f.matrixTransform(r.inverse())}}(O),this.render()}function o(){return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}function i(e,t,r,o,i,s){o.save(),o.fillStyle=i,o.fillRect(e-r/2,t-r/2,r,r),o.fillStyle=s,o.fillRect(e-(r-3)/2,t-(r-3)/2,r-3,r-3),o.restore()}function s(e,t,r,o,i){if(n(e,r,i)&&n(t,o,i))return!0}function n(e,t,r){return Math.abs(e-t)<r}function a(e){var t={};return e.reduce(function(e,r){return t[r.uuid]||(t[r.uuid]=e.push(r)),e},[])}return r});